import{assert,COMMAND_LINE_ARGS,copyFileSync,existsSync,FILE_CREATE_NEW_AND_MODE_ALL,FILE_MODE_ALL,getFilenameTimestampPostfix,HTML_TAG_BEGIN__EN_US,HTML_TAG_BEGIN__ZH_CN,HTML_TAG_BEGIN__ZH_TW,HTML_TAG_END__EN_US,HTML_TAG_END__ZH_CN,HTML_TAG_END__ZH_TW,I18N_HTML_BEGIN_TAG_LENGTH,I18N_LANG_ARRAY,I18N_LANG_NAME,joinPath,LF,mkdirSync,readTextFileSync,SEP,SEPARATOR_OF_SPLIT,statSync,writeTextFileSync}from"https://raw.githubusercontent.com/anqisoft/ts_utils/main/index.ts";import{showHelpOrVersionOrCallbackAndShowUsedTime}from"https://raw.githubusercontent.com/anqisoft/ts_command_line_help/main/index.ts";import{SeleniumHelper}from"https://raw.githubusercontent.com/anqisoft/ts_selenium/main/index.ts";import{GOOGLE_TRANSLATE_LANG_CN,GOOGLE_TRANSLATE_LANG_EN,GOOGLE_TRANSLATE_LANG_TW,translateByGoogle}from"https://raw.githubusercontent.com/anqisoft/ts_translate_by_google/main/index.ts";const EN_US_PATCH_REPLACE_FROM=new RegExp(HTML_TAG_BEGIN__EN_US.concat(" ([^\n]+) ",HTML_TAG_END__EN_US),"g");const EN_US_PATCH_REPLACE_TO=`${HTML_TAG_BEGIN__EN_US}\$1${HTML_TAG_END__EN_US}`;const ZH_TW_PATCH_REPLACE_FROM=new RegExp(HTML_TAG_BEGIN__ZH_TW.concat(" ([^\n]+) ",HTML_TAG_END__ZH_TW),"g");const ZH_TW_PATCH_REPLACE_TO=`${HTML_TAG_BEGIN__ZH_TW}\$1${HTML_TAG_END__ZH_TW}`;const HTML_TAG_BEGIN_OR_END_I18N_ANY_PATTERN=/((\<|\<\/)(en_us|zh_cn|zh_tw)\>)/g;async function splitCommentCore(e,_,t){const n=statSync(_);assert(n.isFile);mkdirSync(t,{recursive:true});assert(statSync(t).isDirectory);const s=readTextFileSync(_);const o=s.split(HTML_TAG_BEGIN__EN_US);o.shift();const i=[];const E=[];const N=[];o.forEach((_,e)=>{const t=_.indexOf(HTML_TAG_END__EN_US);assert(t>-1,`${e}: EN_US_END_POS not right.\n${_}`);const n=_.indexOf(HTML_TAG_BEGIN__ZH_CN);assert(n>t,`${e}: ZH_CN_START_POS not right.\n${_}`);const s=_.indexOf(HTML_TAG_END__ZH_CN);assert(s>n,`${e}: ZH_CN_END_POS not right.\n${_}`);const o=_.indexOf(HTML_TAG_BEGIN__ZH_TW);assert(o>s,`${e}: ZH_TW_START_POS not right.\n${_}`);const c=_.indexOf(HTML_TAG_END__ZH_TW);assert(c>o,`${e}: ZH_TW_END_POS not right.\n${_}`);const a=_.substring(0,t);const T=_.substring(n+I18N_HTML_BEGIN_TAG_LENGTH,s);const r=_.substring(o+I18N_HTML_BEGIN_TAG_LENGTH,c);i.push(`${HTML_TAG_BEGIN__EN_US}${a}${HTML_TAG_END__EN_US}`);E.push(`${HTML_TAG_BEGIN__ZH_CN}${T}${HTML_TAG_END__ZH_CN}`);N.push(`${HTML_TAG_BEGIN__ZH_TW}${r}${HTML_TAG_END__ZH_TW}`)});const c=joinPath(t,_.split(SEP).pop(),SEP);mkdirSync(c,{recursive:true});const a=E.join(LF);const T=a;const r=a;const l=[[I18N_LANG_NAME.en_us,i],[I18N_LANG_NAME.zh_cn,E],[I18N_LANG_NAME.zh_tw,N]];for(let _=0;_<3;++_){const A=l[_];const L=A[0];const G=A[1].join(LF);writeTextFileSync(joinPath(c,`${L}.original.txt`),G,FILE_MODE_ALL);const S=joinPath(c,`${L}.txt`);if(!existsSync(S)){switch(_){case 0:writeTextFileSync(S,(await translateByGoogle(e,T,GOOGLE_TRANSLATE_LANG_CN,GOOGLE_TRANSLATE_LANG_EN)).replaceAll(HTML_TAG_BEGIN__ZH_CN,HTML_TAG_BEGIN__EN_US).replaceAll(HTML_TAG_END__ZH_CN,HTML_TAG_END__EN_US).replace(EN_US_PATCH_REPLACE_FROM,EN_US_PATCH_REPLACE_TO),FILE_CREATE_NEW_AND_MODE_ALL);break;case 1:writeTextFileSync(S,G,FILE_CREATE_NEW_AND_MODE_ALL);break;case 2:writeTextFileSync(S,(await translateByGoogle(e,r,GOOGLE_TRANSLATE_LANG_CN,GOOGLE_TRANSLATE_LANG_TW)).replaceAll(HTML_TAG_BEGIN__ZH_CN,HTML_TAG_BEGIN__ZH_TW).replaceAll(HTML_TAG_END__ZH_CN,HTML_TAG_END__ZH_TW).replace(ZH_TW_PATCH_REPLACE_FROM,ZH_TW_PATCH_REPLACE_TO),FILE_CREATE_NEW_AND_MODE_ALL);break;default:break}}}}export async function splitComments(_,e){const t=await SeleniumHelper.getSingletonHeadlessChromeDriver();try{await splitCommentCore(t,_,e);return true}catch(_){console.error(_);return false}finally{await SeleniumHelper.closeSingletonHeadlessChromeDriver()}}function getSplitResultFromGoalFileByLang(_,e){const t=readTextFileSync(joinPath(_,`${e}.txt`)).substring(I18N_HTML_BEGIN_TAG_LENGTH).replace(new RegExp(`</${e}>[\r\n]+<${e}>`,"g"),SEPARATOR_OF_SPLIT).split(SEPARATOR_OF_SPLIT);const n=t.length-1;t[n]=t[n].replace(`</${e}>`,"");return t}export function joinComments(_,e){try{const t=statSync(_);assert(t.isFile);assert(statSync(e).isDirectory);const n=readTextFileSync(_);const s=_.concat(getFilenameTimestampPostfix(),".bak");if(!existsSync(s)){writeTextFileSync(s,n)}const o=(_.startsWith(SEP)?SEP:"").concat(joinPath(e,_.split(SEP).pop(),SEP));const c=getSplitResultFromGoalFileByLang(o,I18N_LANG_NAME.en_us);const a=getSplitResultFromGoalFileByLang(o,I18N_LANG_NAME.zh_cn);const T=getSplitResultFromGoalFileByLang(o,I18N_LANG_NAME.zh_tw);const r=n.replace(HTML_TAG_BEGIN_OR_END_I18N_ANY_PATTERN,SEPARATOR_OF_SPLIT).split(SEPARATOR_OF_SPLIT);const i=c.length;assert(i===a.length&&i===T.length);for(let _=0;_<i;++_){const E=6*_;r[E+1]=`${HTML_TAG_BEGIN__EN_US}${c[_]}${HTML_TAG_END__EN_US}`;r[E+3]=`${HTML_TAG_BEGIN__ZH_CN}${a[_]}${HTML_TAG_END__ZH_CN}`;r[E+5]=`${HTML_TAG_BEGIN__ZH_TW}${T[_]}${HTML_TAG_END__ZH_TW}`}writeTextFileSync(_,r.join(""));return true}catch(_){console.error(_);return false}}async function cn2trilingualCore(_,e){const t=6;const n=statSync(e);assert(n.isFile);const s=readTextFileSync(e);const o=e.concat(getFilenameTimestampPostfix(),".bak");if(!existsSync(o)){writeTextFileSync(o,s)}const c=[];const a=[];const T=[];const r=s.replace(HTML_TAG_BEGIN_OR_END_I18N_ANY_PATTERN,SEPARATOR_OF_SPLIT).split(SEPARATOR_OF_SPLIT);const i=r.length-t;for(let _=0;_<i;_+=t){a.push(`${HTML_TAG_BEGIN__ZH_CN}${r[_+3]}${HTML_TAG_END__ZH_CN}`)}const E=a.join(LF);const N=E;const l=E;c.length=0;T.length=0;const A=(await translateByGoogle(_,N,GOOGLE_TRANSLATE_LANG_CN,GOOGLE_TRANSLATE_LANG_EN)).replaceAll(HTML_TAG_BEGIN__ZH_CN,HTML_TAG_BEGIN__EN_US).replaceAll(HTML_TAG_END__ZH_CN,HTML_TAG_END__EN_US).replace(EN_US_PATCH_REPLACE_FROM,EN_US_PATCH_REPLACE_TO);A.substring(I18N_HTML_BEGIN_TAG_LENGTH,A.length-I18N_HTML_BEGIN_TAG_LENGTH-1).replace(new RegExp(`${HTML_TAG_END__EN_US}\n${HTML_TAG_BEGIN__EN_US}`,"g"),SEPARATOR_OF_SPLIT).split(SEPARATOR_OF_SPLIT).forEach(_=>c.push(_));const L=(await translateByGoogle(_,l,GOOGLE_TRANSLATE_LANG_CN,GOOGLE_TRANSLATE_LANG_TW)).replaceAll(HTML_TAG_BEGIN__ZH_CN,HTML_TAG_BEGIN__ZH_TW).replaceAll(HTML_TAG_END__ZH_CN,HTML_TAG_END__ZH_TW).replace(ZH_TW_PATCH_REPLACE_FROM,ZH_TW_PATCH_REPLACE_TO);L.substring(I18N_HTML_BEGIN_TAG_LENGTH,L.length-I18N_HTML_BEGIN_TAG_LENGTH-1).replace(new RegExp(`${HTML_TAG_END__ZH_TW}\n${HTML_TAG_BEGIN__ZH_TW}`,"g"),SEPARATOR_OF_SPLIT).split(SEPARATOR_OF_SPLIT).forEach(_=>T.push(_));const G=c.length;for(let _=0;_<G;++_){const S=t*_;r[S+1]=`${HTML_TAG_BEGIN__EN_US}${c[_]}${HTML_TAG_END__EN_US}`;r[S+3]=`${a[_]}`;r[S+5]=`${HTML_TAG_BEGIN__ZH_TW}${T[_]}${HTML_TAG_END__ZH_TW}`}writeTextFileSync(e,r.join(""))}export async function cn2trilingual(e){const t=await SeleniumHelper.getSingletonHeadlessChromeDriver();const n=e.length;for(let _=0;_<n;++_){const s=e[_];try{await cn2trilingualCore(t,s)}catch(_){console.error(s,_);return false}}await SeleniumHelper.closeSingletonHeadlessChromeDriver();return true}function removeLangSeg(_,e){return _.replace(new RegExp(`[\\r\\n]+(([\\#]+[\\ \\t]+)|([\\ \\t]*\\/\\/[\\ \\t]*)|([\\ \\t]*\\*[\\ \\t]*))<${e}>`,"g"),`<${e}>`).replace(new RegExp(`</${e}>`,"g"),"\0".concat(`</${e}>`)).replace(new RegExp(`<${e}[^\0]+\0<\/${e}>`,"g"),"")}function keepByLang(_,e,t){let n=_;switch(e){case I18N_LANG_NAME.en_us:break;case I18N_LANG_NAME.zh_cn:n=n.replace(new RegExp(`([\\r\\n]+(([\\#]+[\\ \\t]+)|([\\ \\t]*\\/\\/[\\ \\t]*)|([\\ \\t]*\\*[\\ \\t]*)))${HTML_TAG_BEGIN__EN_US}[^\r\n]+${HTML_TAG_END__EN_US}<${e}>`,"g"),`$1<${e}>`);break;case I18N_LANG_NAME.zh_tw:n=n.replace(new RegExp(`([\\r\\n]+(([\\#]+[\\ \\t]+)|([\\ \\t]*\\/\\/[\\ \\t]*)|([\\ \\t]*\\*[\\ \\t]*)))${HTML_TAG_BEGIN__EN_US}[^\r\n]+${HTML_TAG_END__EN_US}${HTML_TAG_BEGIN__ZH_CN}[^\r\n]+${HTML_TAG_END__ZH_CN}<${e}>`,"g"),`$1<${e}>`);break;default:break}I18N_LANG_ARRAY.filter(_=>_!==e).forEach(_=>{n=removeLangSeg(n,_)});if(!t){n=n.replace(new RegExp(`(<|</)${e}>`,"g"),"")}return n}export function splitReadmeFiles(e,t){const n=t.length;for(let _=0;_<n;++_){const s=t[_];try{if(s.toLowerCase().lastIndexOf("readme.md")===-1){continue}const o=readTextFileSync(s);const c=s.substring(0,s.toLowerCase().lastIndexOf("readme.md"));I18N_LANG_ARRAY.forEach(_=>{writeTextFileSync(c.concat(`README.${_}.md`),keepByLang(o,_,e))})}catch(_){console.error(s,_);return false}}return true}export function splitFiles(n,e){const t=e.length;for(let _=0;_<t;++_){const s=e[_];try{const o=s.split(SEP);const c=o.pop();const a=(s.startsWith(SEP)?SEP:"").concat(joinPath(o.join(SEP),"i18n"));const T=()=>{const _=readTextFileSync(s);[[I18N_LANG_NAME.en_us,removeLangSeg(removeLangSeg(_,I18N_LANG_NAME.zh_cn),I18N_LANG_NAME.zh_tw)],[I18N_LANG_NAME.zh_cn,removeLangSeg(removeLangSeg(_,I18N_LANG_NAME.en_us),I18N_LANG_NAME.zh_tw)],[I18N_LANG_NAME.zh_tw,removeLangSeg(removeLangSeg(_,I18N_LANG_NAME.en_us),I18N_LANG_NAME.zh_cn)]].forEach(([_,e])=>{const t=joinPath(a,_);mkdirSync(t,{recursive:true});writeTextFileSync(joinPath(t,c),n?e:e.replaceAll(`<${_}>`,"").replaceAll(`</${_}>`,""))})};switch(c.split(".").pop()?.toLowerCase()){case"md":case"xml":case"ini":case"txt":case"log":case"sass":case"scss":case"less":case"css":case"html":case"htm":case"h":case"cs":case"bas":case"php":case"py":case"rs":case"java":case"bat":case"ps1":case"js":case"ts":T();break;default:I18N_LANG_ARRAY.forEach(_=>{const e=joinPath(a,_);mkdirSync(e,{recursive:true});copyFileSync(s,joinPath(e,c))});break}}catch(_){console.error(s,_);return false}}return true}showHelpOrVersionOrCallbackAndShowUsedTime({en_us:"This tool is used to assist in internationalization operations of code or README.md and other files, such as splitting, merging, and translating.",zh_cn:"本工具用于辅助代码或README.md等文件的国际化操作，如拆分、合并、翻译等。",zh_tw:"本工具用於輔助程式碼或README.md等檔案的國際化操作，如分割、合併、翻譯等。"},"0.0.1",2,async()=>{const[_,e,...t]=COMMAND_LINE_ARGS;switch(_){case"splitComments":console.log(await splitComments(e,t[0]));break;case"joinComments":console.log(joinComments(e,t[0]));break;case"cn2trilingual":console.log(await cn2trilingual([e,...t]));break;case"splitReadmeFiles":console.log(splitReadmeFiles(e==="true",[...t]));break;case"splitFiles":console.log(splitFiles(e==="true",[...t]));break;case"txtCn2trilingual":console.log(await txtCn2trilingual([e,...t]));break;default:break}});export async function txtCn2trilingual(e){const t=await SeleniumHelper.getSingletonHeadlessChromeDriver();const n=e.length;for(let _=0;_<n;++_){const s=e[_];try{await txtCn2trilingualCore(t,s)}catch(_){console.error(s,_);return false}}await SeleniumHelper.closeSingletonHeadlessChromeDriver();return true}async function txtCn2trilingualCore(_,e){const t=statSync(e);assert(t.isFile);const n=readTextFileSync(e);const s=e.concat(getFilenameTimestampPostfix(),".bak");if(!existsSync(s)){writeTextFileSync(s,n)}const o=e.split(SEP);const c=o.pop();const a=(e.startsWith(SEP)?SEP:"").concat(o.join(SEP));const T=c.split(".");const r=T.pop();const i=T.join(".");const E=joinPath(a,i.concat(".en_us.",r));if(!existsSync(E)){const l=await translateByGoogle(_,n,GOOGLE_TRANSLATE_LANG_CN,GOOGLE_TRANSLATE_LANG_EN);writeTextFileSync(E,l)}const N=joinPath(a,i.concat(".zh_tw.",r));if(!existsSync(N)){const A=await translateByGoogle(_,n,GOOGLE_TRANSLATE_LANG_CN,GOOGLE_TRANSLATE_LANG_TW);writeTextFileSync(N,A)}}